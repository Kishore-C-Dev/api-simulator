<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout}">
<head>
    <title>Test Panel - API Simulator</title>
</head>
<body>
    <div th:fragment="content">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900">API Test Panel</h1>
                <a th:href="@{/}" class="text-blue-600 hover:text-blue-800">‚Üê Back to Dashboard</a>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Test Echo Endpoint -->
                <div class="space-y-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Test Echo Endpoint</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            Send a test request to <code class="bg-gray-100 px-2 py-1 rounded">/test/echo</code> 
                            to verify JSON handling and response formatting.
                        </p>
                    </div>

                    <form hx-post="/test/echo" 
                          hx-target="#echo-result" 
                          hx-indicator="#echo-spinner"
                          class="space-y-4">
                        
                        <div>
                            <label for="test-headers" class="block text-sm font-medium text-gray-700 mb-2">
                                Request Headers (JSON format)
                            </label>
                            <textarea id="test-headers" name="headers" rows="3"
                                      placeholder='{"X-Custom-Header": "test-value", "X-Tenant": "demo"}'
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                        </div>

                        <div>
                            <label for="test-body" class="block text-sm font-medium text-gray-700 mb-2">
                                Request Body (JSON)
                            </label>
                            <textarea id="test-body" name="body" rows="8"
                                      placeholder='{"message": "Hello API Simulator", "data": {"key": "value", "numbers": [1, 2, 3]}, "timestamp": "2024-01-01T00:00:00Z"}'
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                        </div>

                        <button type="submit" 
                                class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <div id="echo-spinner" class="htmx-indicator spinner mr-2"></div>
                            Send Test Request
                        </button>
                    </form>
                </div>

                <!-- Test Result -->
                <div class="space-y-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Response</h2>
                        <div id="echo-result" class="min-h-96 bg-gray-50 rounded-lg p-4 border">
                            <p class="text-gray-500 text-center py-8">Send a test request to see the response here</p>
                        </div>
                    </div>

                    <!-- Quick Test Buttons -->
                    <div class="space-y-3">
                        <h3 class="text-md font-semibold text-gray-800">Quick Tests</h3>
                        <div class="space-y-2">
                            <button onclick="sendQuickTest('simple')" 
                                    class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-left">
                                Simple JSON Test
                            </button>
                            <button onclick="sendQuickTest('complex')" 
                                    class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors text-left">
                                Complex JSON Test
                            </button>
                            <button onclick="sendQuickTest('empty')" 
                                    class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-left">
                                Empty Body Test
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WireMock Test Section -->
            <div class="mt-12 pt-8 border-t">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Test WireMock Endpoints</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Test your configured WireMock endpoints. Make sure you have created some mappings first.
                    WireMock is running on port <code class="bg-gray-100 px-2 py-1 rounded">9999</code>.
                </p>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Testing WireMock Endpoints</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>To test your WireMock mappings, use tools like curl, Postman, or any HTTP client to make requests to:</p>
                                <code class="bg-yellow-100 px-2 py-1 rounded mt-2 inline-block">http://localhost:9999/your-endpoint</code>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">Example: GET Request</h4>
                        <code class="text-blue-800 text-xs">
                            curl http://localhost:9999/hello
                        </code>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-900 mb-2">Example: POST Request</h4>
                        <code class="text-green-800 text-xs">
                            curl -X POST http://localhost:9999/orders<br>
                            -H "Content-Type: application/json"<br>
                            -d '{"item": "test"}'
                        </code>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-900 mb-2">View WireMock Admin</h4>
                        <p class="text-purple-800 text-xs">
                            Access WireMock admin interface at:<br>
                            <a href="http://localhost:9999/__admin" target="_blank" class="underline">
                                http://localhost:9999/__admin
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function sendQuickTest(type) {
                let headers = '';
                let body = '';
                
                switch(type) {
                    case 'simple':
                        headers = '{"Content-Type": "application/json"}';
                        body = '{"message": "Hello World", "timestamp": "' + new Date().toISOString() + '"}';
                        break;
                    case 'complex':
                        headers = '{"Content-Type": "application/json", "X-Request-ID": "test-123"}';
                        body = JSON.stringify({
                            user: {
                                id: 123,
                                name: "John Doe",
                                email: "john@example.com"
                            },
                            preferences: {
                                theme: "dark",
                                notifications: true,
                                languages: ["en", "es"]
                            },
                            metadata: {
                                timestamp: new Date().toISOString(),
                                version: "1.0.0"
                            }
                        }, null, 2);
                        break;
                    case 'empty':
                        headers = '{"X-Test": "empty-body"}';
                        body = '';
                        break;
                }
                
                document.getElementById('test-headers').value = headers;
                document.getElementById('test-body').value = body;
                
                // Trigger the form submission
                htmx.trigger('#test-body', 'change');
                document.querySelector('form').querySelector('button[type="submit"]').click();
            }

            // Format JSON response in the result area
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                if (evt.detail.target.id === 'echo-result') {
                    try {
                        const response = JSON.parse(evt.detail.xhr.responseText);
                        const formatted = JSON.stringify(response, null, 2);
                        evt.detail.target.innerHTML = 
                            '<div class="bg-white border rounded p-4">' +
                            '<h4 class="text-sm font-semibold text-gray-700 mb-2">JSON Response:</h4>' +
                            '<pre class="text-sm text-gray-800 overflow-x-auto"><code>' + 
                            formatted + 
                            '</code></pre></div>';
                    } catch (e) {
                        // If not JSON, display as-is
                        evt.detail.target.innerHTML = 
                            '<div class="bg-white border rounded p-4">' +
                            '<h4 class="text-sm font-semibold text-gray-700 mb-2">Response:</h4>' +
                            '<pre class="text-sm text-gray-800 overflow-x-auto">' + 
                            evt.detail.xhr.responseText + 
                            '</pre></div>';
                    }
                }
            });
        </script>
    </div>
</body>
</html>