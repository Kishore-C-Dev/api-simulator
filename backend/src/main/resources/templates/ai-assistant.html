<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AI Assistant</title>
</head>
<body>
    <!-- AI Assistant Floating Button and Panel -->
    <th:block th:fragment="ai-assistant">
    <div id="ai-assistant-container">
        <!-- AI Toggle Button -->
        <button id="ai-toggle-btn"
                class="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-50 flex items-center space-x-2"
                onclick="toggleAIPanel()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span class="font-semibold">AI Assistant</span>
        </button>

        <!-- AI Panel (Hidden by default) -->
        <div id="ai-panel"
             class="hidden fixed bg-white rounded-lg shadow-2xl z-50 overflow-hidden border border-gray-200"
             style="bottom: 6rem; right: 1.5rem; width: 24rem; max-height: calc(100vh - 8rem);">

            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <h3 class="font-bold text-lg">AI Assistant</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Expand button -->
                    <button onclick="toggleExpandPanel()" class="hover:bg-white/20 rounded p-1" title="Expand/Collapse">
                        <svg id="expand-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                    <!-- Clear chat button -->
                    <button onclick="clearChatHistory()" class="hover:bg-white/20 rounded p-1" title="Clear Chat History">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <!-- Close button -->
                    <button onclick="toggleAIPanel()" class="hover:bg-white/20 rounded p-1" title="Close">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat History -->
            <div id="ai-chat-history" class="p-4 space-y-3 overflow-y-auto" style="height: calc(100vh - 20rem); max-height: 500px; background: #f9fafb;">
                <div class="text-center text-gray-500 text-sm">
                    <p class="mb-2">üëã Hi! I'm your AI assistant.</p>
                    <p>I can help you with API simulation tasks!</p>
                    <div class="mt-4 text-left bg-white p-3 rounded-lg shadow-sm text-xs space-y-2">
                        <p class="font-semibold text-gray-700">üí° I can help you:</p>

                        <p class="text-xs text-gray-500 mt-1">üìç <strong>API Management:</strong></p>
                        <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                            <li>"Create GET /api/users endpoint"</li>
                            <li>"Show me all my endpoints"</li>
                            <li>"Delete the old orders endpoint"</li>
                        </ul>

                        <p class="text-xs text-gray-500 mt-2">üîç <strong>Ask Mode - Debug & Analyze:</strong></p>
                        <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                            <li>"Which endpoint matches this payload: {...}"</li>
                            <li>"curl -X POST http://localhost:9999/api/users -d '{}'"</li>
                            <li>"Check if /api/orders matches this request"</li>
                            <li>"What's missing for my payload to match?"</li>
                        </ul>

                        <p class="text-xs text-gray-500 mt-2" th:if="${currentUser != null && currentUser.userId == 'admin'}">üëë <strong>Admin Tasks:</strong></p>
                        <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2" th:if="${currentUser != null && currentUser.userId == 'admin'}">
                            <li>"Create a new namespace called 'team-alpha'"</li>
                            <li>"Add user john with email john@example.com"</li>
                            <li>"Disable user developer"</li>
                            <li>"Assign tester to namespace team-alpha"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-200 bg-white">
                <form id="ai-form" onsubmit="sendAIRequest(event)">
                    <div class="flex space-x-2">
                        <textarea id="ai-input"
                                  placeholder="Describe the endpoint you want to create..."
                                  class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                                  rows="2"></textarea>
                        <button type="submit"
                                id="ai-submit-btn"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Store chat history in localStorage
        const AI_CHAT_STORAGE_KEY = 'ai-assistant-chat-history';
        const AI_PANEL_STATE_KEY = 'ai-assistant-panel-open';
        const AI_PANEL_EXPANDED_KEY = 'ai-assistant-panel-expanded';

        window.toggleAIPanel = function() {
            const panel = document.getElementById('ai-panel');
            const chatHistory = document.getElementById('ai-chat-history');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('animate-fade-in');
                localStorage.setItem(AI_PANEL_STATE_KEY, 'true');
                // Scroll to bottom when opening panel
                setTimeout(() => {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }, 50);
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('animate-fade-in');
                localStorage.setItem(AI_PANEL_STATE_KEY, 'false');
            }
        };

        window.toggleExpandPanel = function() {
            const panel = document.getElementById('ai-panel');
            const chatHistory = document.getElementById('ai-chat-history');
            const isExpanded = panel.classList.contains('ai-expanded');

            if (isExpanded) {
                // Collapse to normal size
                panel.classList.remove('ai-expanded');
                panel.style.width = '24rem'; // 384px
                panel.style.maxWidth = '90vw'; // Responsive max width
                panel.style.maxHeight = 'calc(100vh - 8rem)';
                panel.style.right = '1.5rem';
                chatHistory.style.height = 'calc(100vh - 20rem)';
                chatHistory.style.maxHeight = '500px';
                localStorage.setItem(AI_PANEL_EXPANDED_KEY, 'false');
            } else {
                // Expand to larger size
                panel.classList.add('ai-expanded');
                panel.style.width = '48rem'; // 768px
                panel.style.maxWidth = '95vw'; // Responsive max width
                panel.style.maxHeight = 'calc(100vh - 8rem)';
                panel.style.right = '1.5rem';
                chatHistory.style.height = 'calc(100vh - 20rem)';
                chatHistory.style.maxHeight = 'none';
                localStorage.setItem(AI_PANEL_EXPANDED_KEY, 'true');
            }

            // Scroll to bottom after resize
            setTimeout(() => {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 100);
        };

        window.clearChatHistory = function() {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                // Clear localStorage
                localStorage.removeItem(AI_CHAT_STORAGE_KEY);

                // Reset chat history display
                const chatHistory = document.getElementById('ai-chat-history');
                chatHistory.innerHTML = `
                    <div class="text-center text-gray-500 text-sm">
                        <p class="mb-2">üëã Hi! I'm your AI assistant.</p>
                        <p>I can help you with API simulation tasks!</p>
                        <div class="mt-4 text-left bg-white p-3 rounded-lg shadow-sm text-xs space-y-2">
                            <p class="font-semibold text-gray-700">üí° I can help you:</p>

                            <p class="text-xs text-gray-500 mt-1">üìç <strong>API Management:</strong></p>
                            <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                                <li>"Create GET /api/users endpoint"</li>
                                <li>"Show me all my endpoints"</li>
                                <li>"Delete the old orders endpoint"</li>
                            </ul>

                            <p class="text-xs text-gray-500 mt-2">üîç <strong>Ask Mode - Debug & Analyze:</strong></p>
                            <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                                <li>"Which endpoint matches this payload: {...}"</li>
                                <li>"curl -X POST http://localhost:9999/api/users -d '{}'"</li>
                                <li>"Check if /api/orders matches this request"</li>
                                <li>"What's missing for my payload to match?"</li>
                            </ul>
                        </div>
                    </div>
                `;

                // Show confirmation
                addMessage('‚úÖ Chat history cleared!', false);
            }
        };

        window.addMessage = function(text, isUser = false) {
            const chatHistory = document.getElementById('ai-chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-xs rounded-lg px-4 py-2 ${
                isUser
                ? 'bg-purple-600 text-white'
                : 'bg-white text-gray-800 shadow-sm border border-gray-200'
            }`;
            bubble.innerHTML = text;

            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Save message to localStorage
            saveChatHistory(text, isUser);
        };

        function saveChatHistory(text, isUser) {
            try {
                let history = JSON.parse(localStorage.getItem(AI_CHAT_STORAGE_KEY) || '[]');
                history.push({
                    text: text,
                    isUser: isUser,
                    timestamp: new Date().toISOString()
                });
                // Keep only last 50 messages
                if (history.length > 50) {
                    history = history.slice(-50);
                }
                localStorage.setItem(AI_CHAT_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save chat history:', e);
            }
        }

        function loadChatHistory() {
            try {
                const history = JSON.parse(localStorage.getItem(AI_CHAT_STORAGE_KEY) || '[]');
                const chatHistory = document.getElementById('ai-chat-history');

                // Clear welcome message if history exists
                if (history.length > 0) {
                    chatHistory.innerHTML = '';
                }

                // Load messages
                history.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex ${msg.isUser ? 'justify-end' : 'justify-start'}`;

                    const bubble = document.createElement('div');
                    bubble.className = `max-w-xs rounded-lg px-4 py-2 ${
                        msg.isUser
                        ? 'bg-purple-600 text-white'
                        : 'bg-white text-gray-800 shadow-sm border border-gray-200'
                    }`;
                    bubble.innerHTML = msg.text;

                    messageDiv.appendChild(bubble);
                    chatHistory.appendChild(messageDiv);
                });

                chatHistory.scrollTop = chatHistory.scrollHeight;
            } catch (e) {
                console.error('Failed to load chat history:', e);
            }
        }

        function buildConversationHistory() {
            try {
                const history = JSON.parse(localStorage.getItem(AI_CHAT_STORAGE_KEY) || '[]');

                // Convert to the format expected by backend
                // Keep last 10 messages for context (5 exchanges)
                const recentHistory = history.slice(-10);

                return recentHistory.map(msg => ({
                    role: msg.isUser ? 'user' : 'assistant',
                    content: msg.text
                }));
            } catch (e) {
                console.error('Failed to build conversation history:', e);
                return [];
            }
        }

        window.sendAIRequest = async function(event) {
            event.preventDefault();

            const input = document.getElementById('ai-input');
            const submitBtn = document.getElementById('ai-submit-btn');
            const userPrompt = input.value.trim();

            if (!userPrompt) return;

            // Add user message
            addMessage(userPrompt, true);
            input.value = '';

            // Disable submit button
            submitBtn.disabled = true;

            // Add loading message
            addMessage('ü§î Thinking...', false);

            try {
                // Build conversation history from localStorage
                const conversationHistory = buildConversationHistory();

                const response = await fetch('/api/ai/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userPrompt: userPrompt,
                        conversationHistory: conversationHistory
                        // taskType will be auto-detected by the AI service
                    })
                });

                const data = await response.json();

                // Remove loading message
                const chatHistory = document.getElementById('ai-chat-history');
                chatHistory.removeChild(chatHistory.lastChild);

                if (data.success) {
                    // Check action type
                    if (data.action === 'delete' && data.mappingId) {
                        // Show delete confirmation for mapping
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`${formattedText}<br>
                                   <button onclick="confirmDeleteMapping('${data.mappingId}')"
                                           class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                       Confirm Delete
                                   </button>
                                   <button onclick="addMessage('‚ùå Deletion cancelled', false)"
                                           class="mt-2 bg-gray-400 text-white px-3 py-1 rounded text-sm hover:bg-gray-500">
                                       Cancel
                                   </button>`, false);
                    } else if (data.action === 'delete_namespace' && data.mappingId) {
                        // Show delete confirmation for namespace
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`${formattedText}<br>
                                   <button onclick="confirmDeleteNamespace('${data.mappingId}')"
                                           class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                       Confirm Delete
                                   </button>
                                   <button onclick="addMessage('‚ùå Deletion cancelled', false)"
                                           class="mt-2 bg-gray-400 text-white px-3 py-1 rounded text-sm hover:bg-gray-500">
                                       Cancel
                                   </button>`, false);
                    } else if (data.action === 'delete_user' && data.mappingId) {
                        // Show delete confirmation for user
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`${formattedText}<br>
                                   <button onclick="confirmDeleteUser('${data.mappingId}')"
                                           class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                       Confirm Delete
                                   </button>
                                   <button onclick="addMessage('‚ùå Deletion cancelled', false)"
                                           class="mt-2 bg-gray-400 text-white px-3 py-1 rounded text-sm hover:bg-gray-500">
                                       Cancel
                                   </button>`, false);
                    } else if (data.action === 'modify' && data.mappingId) {
                        // Show modification instructions
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`‚úèÔ∏è ${formattedText}<br>
                                   <button onclick="window.location.href='/mappings/${data.mappingId}/edit'"
                                           class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                       Edit Mapping
                                   </button>`, false);
                    } else if (data.action === 'modify_complete' && data.mappingId) {
                        // Modification completed successfully
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`${formattedText}<br>
                                   <button onclick="window.location.href='/mappings/${data.mappingId}/edit'"
                                           class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                       View Updated Mapping
                                   </button>
                                   <button onclick="window.location.reload()"
                                           class="mt-2 bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                       Refresh Page
                                   </button>`, false);
                    } else if (data.action === 'list') {
                        // Show list of mappings
                        const formattedText = data.explanation ? data.explanation.replace(/\n/g, '<br>') : '';
                        addMessage(`üìã ${formattedText}`, false);
                    } else if (data.generatedMapping) {
                        // Show success message with apply button (create)
                        const mappingJson = JSON.stringify(data.generatedMapping);
                        const buttonId = 'apply-btn-' + Date.now();
                        addMessage(`‚úÖ Generated mapping: <strong>${data.generatedMapping.name}</strong><br>
                                   <button id="${buttonId}"
                                           class="mt-2 bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                       Apply Mapping
                                   </button>`, false);

                        // Attach click handler after message is added
                        setTimeout(() => {
                            const btn = document.getElementById(buttonId);
                            if (btn) {
                                btn.onclick = () => applyMapping(encodeURIComponent(mappingJson));
                            }
                        }, 100);
                    } else if (data.explanation) {
                        // Show explanation or debug info
                        const formattedText = data.explanation.replace(/\n/g, '<br>');
                        addMessage(`üí° ${formattedText}`, false);
                    } else if (data.suggestions && data.suggestions.length > 0) {
                        // Show suggestions
                        const suggestionsList = data.suggestions.map(s => `‚Ä¢ ${s}`).join('<br>');
                        addMessage(`üìã <strong>Suggestions:</strong><br>${suggestionsList}`, false);
                    } else {
                        addMessage(`‚úÖ ${data.message}`, false);
                    }
                } else {
                    addMessage(`‚ùå Error: ${data.message}`, false);
                }

            } catch (error) {
                // Remove loading message
                const chatHistory = document.getElementById('ai-chat-history');
                chatHistory.removeChild(chatHistory.lastChild);

                addMessage(`‚ùå Error: ${error.message}`, false);
            } finally {
                submitBtn.disabled = false;
            }
        }

        window.applyMapping = function(mappingJson) {
            try {
                console.log('applyMapping called with:', mappingJson);
                const mapping = JSON.parse(decodeURIComponent(mappingJson));
                console.log('Parsed mapping:', mapping);

                // Redirect to the appropriate form based on endpoint type
                if (mapping.endpointType === 'GRAPHQL') {
                    window.location.href = '/mappings/new/graphql?ai-data=' + encodeURIComponent(mappingJson);
                } else {
                    window.location.href = '/mappings/new?ai-data=' + encodeURIComponent(mappingJson);
                }
            } catch (error) {
                console.error('Error in applyMapping:', error);
                addMessage('‚ùå Error applying mapping: ' + error.message, false);
            }
        };

        window.confirmDeleteMapping = async function(mappingId) {
            try {
                const response = await fetch(`/mappings/${mappingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    addMessage('‚úÖ Mapping deleted successfully!', false);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    addMessage('‚ùå Failed to delete mapping', false);
                }
            } catch (error) {
                addMessage('‚ùå Error deleting mapping: ' + error.message, false);
            }
        };

        window.confirmDeleteNamespace = async function(namespaceName) {
            try {
                const response = await fetch(`/admin/namespaces/${namespaceName}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    addMessage('‚úÖ Namespace deleted successfully!', false);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorText = await response.text();
                    addMessage('‚ùå Failed to delete namespace: ' + errorText, false);
                }
            } catch (error) {
                addMessage('‚ùå Error deleting namespace: ' + error.message, false);
            }
        };

        window.confirmDeleteUser = async function(userId) {
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    addMessage('‚úÖ User deleted successfully!', false);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorText = await response.text();
                    addMessage('‚ùå Failed to delete user: ' + errorText, false);
                }
            } catch (error) {
                addMessage('‚ùå Error deleting user: ' + error.message, false);
            }
        };

        // Handle window resize for responsive adjustments
        window.addEventListener('resize', function() {
            const panel = document.getElementById('ai-panel');
            const chatHistory = document.getElementById('ai-chat-history');

            if (!panel.classList.contains('hidden')) {
                // Recalculate heights on resize
                const isExpanded = panel.classList.contains('ai-expanded');

                if (window.innerWidth <= 768) {
                    // Mobile/tablet view
                    panel.style.maxHeight = 'calc(100vh - 6rem)';
                    chatHistory.style.maxHeight = 'calc(100vh - 16rem)';
                } else {
                    // Desktop view
                    panel.style.maxHeight = 'calc(100vh - 8rem)';
                    if (isExpanded) {
                        chatHistory.style.maxHeight = 'none';
                    } else {
                        chatHistory.style.maxHeight = '500px';
                    }
                }
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load chat history first
            loadChatHistory();

            // Restore panel state
            const panelState = localStorage.getItem(AI_PANEL_STATE_KEY);
            const expandedState = localStorage.getItem(AI_PANEL_EXPANDED_KEY);
            if (panelState === 'true') {
                const panel = document.getElementById('ai-panel');
                const chatHistory = document.getElementById('ai-chat-history');
                if (panel) {
                    panel.classList.remove('hidden');

                    // Restore expanded state with responsive sizing
                    if (expandedState === 'true') {
                        panel.classList.add('ai-expanded');
                        panel.style.width = '48rem';
                        panel.style.maxWidth = '95vw';
                        panel.style.maxHeight = 'calc(100vh - 8rem)';
                        panel.style.right = '1.5rem';
                        chatHistory.style.height = 'calc(100vh - 20rem)';
                        chatHistory.style.maxHeight = 'none';
                    } else {
                        // Apply responsive sizing to collapsed state too
                        panel.style.maxWidth = '90vw';
                        panel.style.maxHeight = 'calc(100vh - 8rem)';
                        chatHistory.style.height = 'calc(100vh - 20rem)';
                        chatHistory.style.maxHeight = '500px';
                    }

                    // Scroll to bottom when panel is restored
                    setTimeout(() => {
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }, 100);
                }
            }

            // Check if AI is enabled
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();

                if (!data.enabled) {
                    const aiContainer = document.getElementById('ai-assistant-container');
                    if (aiContainer) {
                        aiContainer.style.display = 'none';
                    }
                }
            } catch (error) {
                console.log('AI Assistant not available');
                const aiContainer = document.getElementById('ai-assistant-container');
                if (aiContainer) {
                    aiContainer.style.display = 'none';
                }
            }
        });
    </script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }

        /* Responsive adjustments for AI panel */
        @media (max-width: 768px) {
            #ai-panel {
                bottom: 1rem !important;
                right: 1rem !important;
                left: 1rem !important;
                width: auto !important;
                max-width: none !important;
            }

            #ai-toggle-btn {
                bottom: 1rem !important;
                right: 1rem !important;
            }

            #ai-chat-history {
                max-height: calc(100vh - 18rem) !important;
            }
        }

        @media (max-width: 480px) {
            #ai-panel {
                bottom: 0.5rem !important;
                right: 0.5rem !important;
                left: 0.5rem !important;
            }

            #ai-toggle-btn {
                bottom: 0.5rem !important;
                right: 0.5rem !important;
                padding: 0.75rem !important;
            }

            #ai-toggle-btn span {
                display: none;
            }
        }

        /* Ensure panel doesn't cover top navigation */
        #ai-panel {
            top: 4rem; /* Leave space for top menu */
        }
    </style>
    </th:block>
</body>
</html>
